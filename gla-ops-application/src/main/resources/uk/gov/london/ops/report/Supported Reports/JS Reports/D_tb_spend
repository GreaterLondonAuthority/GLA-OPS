select distinct  pj.project_id,  pj.programme, pj.from_date LT_spend_start_yr, pj.to_date LT_spend_end_yr, coalesce(pj.capital,0) LT_approved_CAP, coalesce(pj.revenue,0) LT_approved_REV,    round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0) Pre2012_CAP_Fcast, round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)   Pre2012_CAP_Actual, round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)       Pre2012_CAP_Rem_Act,  round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0) Pre2012_REV_Fcast, round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)   Pre2012_REV_Actual, round(sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month < pj.year_fromP5 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)         Pre2012_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  YR2012_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2012_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        YR2012_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  YR2012_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2012_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP5 and pj.year_toP5 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        YR2012_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  YR2013_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2013_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        YR2013_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  YR2013_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2013_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP4 and pj.year_toP4 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        YR2013_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  YR2014_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2014_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        YR2014_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  YR2014_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2014_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP3 and pj.year_toP3 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        YR2014_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  YR2015_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2015_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        YR2015_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  YR2015_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2015_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP2 and pj.year_toP2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        YR2015_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  YR2016_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2016_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        YR2016_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  YR2016_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2016_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP1 and pj.year_toP1 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        YR2016_REV_Rem_Act,   round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    YR2017_CAP_Fcast, round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)      YR2017_CAP_Actual, round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)          YR2017_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    YR2017_REV_Fcast, round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)      YR2017_REV_Actual, round(sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_fromP and pj.year_toP and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)          YR2017_REV_Rem_Act,    round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CY_CAP_Fcast, round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month < cast(pj.current as int) and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)     CY_CAP_Actual, round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month < cast(pj.current as int) and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        CY_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CY_REV_Fcast, round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month < cast(pj.current as int)  and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CY_REV_Actual, round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month < cast(pj.current as int) and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        CY_REV_Rem_Act,    round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  NY_CAP_Fcast, round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    NY_CAP_Actual, round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        NY_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  NY_REV_Fcast, round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    NY_REV_Actual, round(sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from1 and pj.year_to1 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        NY_REV_Rem_Act,  round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  Year_After_CAP_Fcast, round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    Year_After_CAP_Actual, round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)        Year_After_CAP_Rem_Act,  round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  Year_After_REV_Fcast, round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    Year_After_REV_Actual, round(sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month between pj.year_from2 and pj.year_to2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)        Year_After_REV_Rem_Act,  round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)                          TwoYearsAfter_CAP_Fcast, round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)                            TwoYearsAfter_CAP_Actual, round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month > pj.year_to2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)                                TwoYearsAfter_CAP_Rem_Act,  round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)                          TwoYearsAfter_REV_Fcast, round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)                            TwoYearsAfter_REV_Actual, round(sum(case when pl.year_month > pj.year_to2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end)+ sum(case when pl.year_month > pj.year_to2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)                                TwoYearsAfter_REV_Rem_Act,   round(sum(case when ledger_status ='FORECAST' and spend_type in('REVENUE','CAPITAL') and  pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end),0) - round(sum(case when pl.year_month between '201704'and'201803'and pl.year_month < cast(pj.current as int) and ledger_status ='FORECAST'and spend_type in('REVENUE','CAPITAL') then (pl.amount*-1) else 0 end),0) CAP_REV_TOTAL_Fcast,   round(sum(case when ledger_status ='ACTUAL' and spend_type in('REVENUE','CAPITAL') and  pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end),0) - round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='ACTUAL'and spend_type in('REVENUE','CAPITAL') then (pl.amount*-1) else 0 end),0) CAP_REV_TOTAL_Actual,     round(sum(case when ledger_status ='ACTUAL'and spend_type in('REVENUE','CAPITAL') and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end) + sum(case when ledger_status ='FORECAST'and spend_type in('REVENUE','CAPITAL') and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end),0)  - (round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month >= cast(pj.current as int) and ledger_status ='ACTUAL'and spend_type in('REVENUE','CAPITAL') then (pl.amount*-1) else 0 end),0) + round(sum(case when pl.year_month between pj.year_from and pj.year_to and pl.year_month < cast(pj.current as int) and ledger_status ='FORECAST'and spend_type in('REVENUE','CAPITAL') then (pl.amount*-1) else 0 end),0)) CAP_REV_TOTAL_Rem_Act,        round(case when coalesce(pj.capital,0) >  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  + sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'CAPITAL') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end))  then   coalesce(pj.capital,0) -  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'CAPITAL') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) else 0 end,0) Avail_to_Fcast_CAP,                                                                             round(case when coalesce(pj.revenue,0) >   (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  + sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end))  then   coalesce(pj.revenue,0) -  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) else 0 end,0) Avail_to_Fcast_REV,      round(case when coalesce(pj.capital,0) >  sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  then  coalesce(pj.capital,0) -  sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  else 0 end,0) Left_to_Spend_CAP,      round(case when coalesce(pj.revenue,0) >  sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  then  coalesce(pj.revenue,0) -  sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end) else 0 end,0) Left_to_Spend_REV,       case when pj.capital > 0 or pj.revenue > 0 then ( case when ( (pj.capital+pj.revenue)  >  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) )    then  sum(case when ledger_status = 'FORECAST' AND spend_type IN('CAPITAL') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end) else 0 end ) else 0 end Approved_Fcast_CAP,           case when pj.capital > 0 or pj.revenue > 0 then ( case when ( (pj.capital+pj.revenue)  >  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) )    then  sum(case when ledger_status = 'FORECAST' AND spend_type IN('REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end) else 0 end ) else 0 end Approved_Fcast_REV,            case when pj.capital > 0 or pj.revenue > 0 then ( case when ( (pj.capital+pj.revenue)  <  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL','REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'CAPITAL','REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) )    then  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN( 'CAPITAL') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN( 'CAPITAL') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) - (pj.capital)   else 0 end ) else 0 end Unappd_Fcast_CAP,         case when pj.capital > 0 or pj.revenue > 0 then ( case when ( (pj.capital+pj.revenue)  <  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN('CAPITAL','REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) )    then  (sum(case when ledger_status = 'ACTUAL' AND spend_type IN('REVENUE') and pl.year_month < cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)  +  sum(case when ledger_status = 'FORECAST' AND spend_type IN('REVENUE') and pl.year_month >= cast(pj.current as int) and pl.year_month between cast(text(left(pj.from_date,4)||'04') as int) and cast(text((cast(left(pj.to_date,4) as int)+1)||'03') as int) then (pl.amount*-1) else 0 end)) -(pj.revenue)  else 0 end ) else 0 end Unappd_Fcast_REV,          round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='CAPITAL' then (pl.amount) else 0 end),0)  CAP_CurrYr_Budget, round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='REVENUE' then (pl.amount) else 0 end),0)  REV_CurrYr_Budget,   round(sum(case when pl.year_month = pj.mth1 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Apr_CAP_Fcast, round(sum(case when pl.year_month = pj.mth1 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Apr_CAP_Act, round(sum(case when pl.year_month = pj.mth1 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Apr_REV_Fcast, round(sum(case when pl.year_month = pj.mth1 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Apr_REV_Act,  round(sum(case when pl.year_month = pj.mth2 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_May_CAP_Fcast, round(sum(case when pl.year_month = pj.mth2 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_May_CAP_Act, round(sum(case when pl.year_month = pj.mth2 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_May_REV_Fcast, round(sum(case when pl.year_month = pj.mth2 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_May_REV_Act,  round(sum(case when pl.year_month = pj.mth3 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Jun_CAP_Fcast, round(sum(case when pl.year_month = pj.mth3 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Jun_CAP_Act, round(sum(case when pl.year_month = pj.mth3 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Jun_REV_Fcast, round(sum(case when pl.year_month = pj.mth3 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Jun_REV_Act,  round(sum(case when pl.year_month = pj.mth4 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Jul_CAP_Fcast, round(sum(case when pl.year_month = pj.mth4 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Jul_CAP_Act, round(sum(case when pl.year_month = pj.mth4 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Jul_REV_Fcast, round(sum(case when pl.year_month = pj.mth4 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Jul_REV_Act,  round(sum(case when pl.year_month = pj.mth5 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Aug_CAP_Fcast, round(sum(case when pl.year_month = pj.mth5 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Aug_CAP_Act, round(sum(case when pl.year_month = pj.mth5 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Aug_REV_Fcast, round(sum(case when pl.year_month = pj.mth5 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Aug_REV_Act,  round(sum(case when pl.year_month = pj.mth6 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Sep_CAP_Fcast, round(sum(case when pl.year_month = pj.mth6 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Sep_CAP_Act, round(sum(case when pl.year_month = pj.mth6 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Sep_REV_Fcast, round(sum(case when pl.year_month = pj.mth6 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Sep_REV_Act,  round(sum(case when pl.year_month = pj.mth7 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Oct_CAP_Fcast, round(sum(case when pl.year_month = pj.mth7 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Oct_CAP_Act, round(sum(case when pl.year_month = pj.mth7 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Oct_REV_Fcast, round(sum(case when pl.year_month = pj.mth7 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Oct_REV_Act,  round(sum(case when pl.year_month = pj.mth8 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Nov_CAP_Fcast, round(sum(case when pl.year_month = pj.mth8 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Nov_CAP_Act, round(sum(case when pl.year_month = pj.mth8 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Nov_REV_Fcast, round(sum(case when pl.year_month = pj.mth8 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Nov_REV_Act,  round(sum(case when pl.year_month = pj.mth9 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CurrYr_Dec_CAP_Fcast, round(sum(case when pl.year_month = pj.mth9 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)    CurrYr_Dec_CAP_Act, round(sum(case when pl.year_month = pj.mth9 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CurrYr_Dec_REV_Fcast, round(sum(case when pl.year_month = pj.mth9 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)    CurrYr_Dec_REV_Act,  round(sum(case when pl.year_month = pj.mth10 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0) CurrYr_Jan_CAP_Fcast, round(sum(case when pl.year_month = pj.mth10 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)   CurrYr_Jan_CAP_Act, round(sum(case when pl.year_month = pj.mth10 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0) CurrYr_Jan_REV_Fcast, round(sum(case when pl.year_month = pj.mth10 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)   CurrYr_Jan_REV_Act,  round(sum(case when pl.year_month = pj.mth11 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0) CurrYr_Feb_CAP_Fcast, round(sum(case when pl.year_month = pj.mth11 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)   CurrYr_Feb_CAP_Act, round(sum(case when pl.year_month = pj.mth11 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0) CurrYr_Feb_REV_Fcast, round(sum(case when pl.year_month = pj.mth11 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)   CurrYr_Feb_REV_Act,  round(sum(case when pl.year_month = pj.mth12 and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0) CurrYr_Mar_CAP_Fcast, round(sum(case when pl.year_month = pj.mth12 and ledger_status ='ACTUAL'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)   CurrYr_Mar_CAP_Act, round(sum(case when pl.year_month = pj.mth12 and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0) CurrYr_Mar_REV_Fcast, round(sum(case when pl.year_month = pj.mth12 and ledger_status ='ACTUAL'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)   CurrYr_Mar_REV_Act,       round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='ACTUAL' and spend_type ='CAPITAL'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)   CurrYr_TOT_CAP_Act,  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='ACTUAL' and spend_type ='REVENUE'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)   CurrYr_TOT_REV_Act,  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST' and spend_type ='CAPITAL'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0)  CurrYr_TOT_CAP_Rem_Fcast,  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST' and spend_type ='REVENUE'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0)  CurrYr_TOT_REV_Rem_Fcast ,            case when sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='CAPITAL' then pl.amount else 0 end) > 0  then  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='CAPITAL' then pl.amount else 0 end),0)- round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='ACTUAL' and spend_type ='CAPITAL'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)    else 0 end   Left_to_Spend_Ann_CAP,     case when sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='BUDGET'and spend_type ='REVENUE' then pl.amount else 0 end) > 0  then  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='REVENUE' then pl.amount else 0 end),0)-  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='ACTUAL' and spend_type ='REVENUE'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)    else 0 end   Left_to_Spend_Ann_REV,        case when sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='CAPITAL' then pl.amount else 0 end) > 0  then  Case when round(sum(case when pl.year_month between  pj.year_from and pj.year_to  and ledger_status ='BUDGET'and spend_type ='CAPITAL' then pl.amount else 0 end),0)-          (round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST' and spend_type ='CAPITAL'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0) +            round(sum(case when pl.year_month between  pj.year_from and pj.year_to  and ledger_status ='ACTUAL' and spend_type ='CAPITAL'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)) < 0 then 0 else   round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='BUDGET'and spend_type ='CAPITAL' then pl.amount else 0 end),0)-          (round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='FORECAST' and spend_type ='CAPITAL'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0) +            round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='ACTUAL' and spend_type ='CAPITAL'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0))  end    else 0 end  Avail_Fcast_Ann_CAP,        case when sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='BUDGET'and spend_type ='REVENUE' then pl.amount else 0 end) > 0  then  case when round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='BUDGET'and spend_type ='REVENUE' then pl.amount else 0 end),0)-  (round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='FORECAST' and spend_type ='REVENUE'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0) + round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='ACTUAL' and spend_type ='REVENUE'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)) < 0 then 0 else   round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='BUDGET'and spend_type ='REVENUE' then pl.amount else 0 end),0)-  (round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST' and spend_type ='REVENUE'  and pl.year_month >= cast(pj.current as int) then (pl.amount*-1) else 0 end),0) + round(sum(case when pl.year_month between pj.year_from and pj.year_to  and ledger_status ='ACTUAL' and spend_type ='REVENUE'  and pl.year_month < cast(pj.current as int) then (pl.amount*-1) else 0 end),0)) end    else 0 end   Avail_Fcast_Ann_REV,         round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST'and spend_type ='CAPITAL' then (pl.amount*-1) else 0 end),0)  CY_total_fcast_CAP,  round(sum(case when pl.year_month between pj.year_from and pj.year_to and ledger_status ='FORECAST'and spend_type ='REVENUE' then (pl.amount*-1) else 0 end),0)  CY_total_fcast_REV         from project_block pb   inner join ( 	   select * from ( select distinct  pj.id project_id,   pj.programme_id,  coalesce(pg.name,'') programme,   t.name project_type, max(ts.id) id2,  max(ts.from_date) from_date,  max(ts.to_date) to_date,  max(ts.capital) capital,  max(ts.revenue) revenue,      max(cast(EXTRACT(YEAR FROM current_date) as int)) curr_yrs, max(cast(EXTRACT(MONTH FROM current_date) as int)) curr_mths,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) < 10 then cast(EXTRACT(YEAR FROM current_date) as int) ||''|| '0'||cast(EXTRACT(MONTH FROM current_date) as int) else  cast(EXTRACT(YEAR FROM current_date) as int) ||''|| cast(EXTRACT(MONTH FROM current_date) as int) end)  as "current",   max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'4' as int ) end) mth1, max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'5' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'5' as int ) end) mth2,  max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'6' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'6' as int ) end) mth3, max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'7' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'7' as int ) end) mth4,  max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'8' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'8' as int ) end) mth5, max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'9' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'9' as int ) end) mth6,  max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'10' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'10' as int ) end)     mth7, max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'11' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'11' as int ) end)     mth8,     max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'12' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'12' as int ) end)     mth9,   max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'1' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'1' as int ) end)   mth10,  max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'2' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'2' as int ) end)   mth11, max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'3' as int ) end)   mth12  ,                     max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'4' as int ) end) year_from,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'3' as int ) end)   year_to,     max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'4' as int ) end)   year_from1,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+2 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'3' as int ) end) year_to1,             max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+2 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)+1 ||'0'||'4' as int ) end) year_from2,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)+3 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)+2 ||'0'||'3' as int ) end) year_to2,            max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date) ||'0'||'4' as int ) end) year_fromP,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date) ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'3' as int ) end) year_toP,  max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-2 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'4' as int ) end) year_fromP1,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-1 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-2 ||'0'||'3' as int ) end) year_toP1,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-3 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-2 ||'0'||'4' as int ) end) year_fromP2,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-2 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-3 ||'0'||'3' as int ) end) year_toP2,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-4 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-3 ||'0'||'4' as int ) end) year_fromP3,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-3 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-4 ||'0'||'3' as int ) end) year_toP3,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-5 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-4 ||'0'||'4' as int ) end) year_fromP4,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-4 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-5 ||'0'||'3' as int ) end) year_toP4,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-6 ||'0'||'4' as int ) else cast(EXTRACT(YEAR FROM current_date)-5 ||'0'||'4' as int ) end) year_fromP5,      max(case when cast(EXTRACT(MONTH FROM current_date) as int) > 3 then cast(EXTRACT(YEAR FROM current_date)-5 ||'0'||'3' as int ) else cast(EXTRACT(YEAR FROM current_date)-6 ||'0'||'3' as int ) end) year_toP5      from project pj  left join project_block pjb on pj.id = pjb.project_id left join organisation org on pj.org_id = org.id left join programme pg on pj.programme_id = pg.id left join template t on pj.template_id = t.id  left join project_budgets ts on pjb.id = ts.id  where pjb.reporting_version = 'true'  group by pj.id, programme_id, pg.name, t.name ) a  order by a.project_id ) pj on pb.project_id = pj.project_id  left join project_ledger_entry pl on pb.project_id = pl.project_id and pb.id = pl.block_id    where pb.reporting_version = 'true'    and pj.from_date is not null  and ( pl.category <> 'Finance use only' or pl.category is null )  GROUP BY  pj.project_id,  pj.project_type, pj.programme, pj.from_date, pj.to_date, pj.capital, pj.revenue  order by 1